name: Validate Shortlist

on:
  pull_request:
    paths:
      - 'shortlist/current-shortlist.md'
  push:
    branches:
      - main
    paths:
      - 'shortlist/current-shortlist.md'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate Markdown table format
        run: |
          # Check that current-shortlist.md exists and is a valid markdown table
          if [ ! -f shortlist/current-shortlist.md ]; then
            echo "Error: shortlist/current-shortlist.md not found"
            exit 1
          fi
          
          # Check for table structure (should have pipe separators)
          if ! grep -q "|" shortlist/current-shortlist.md; then
            echo "Error: shortlist/current-shortlist.md does not appear to be a markdown table"
            exit 1
          fi
          
          echo "✓ Markdown table format appears valid"

      - name: Validate required columns
        run: |
          # Check for required column headers
          REQUIRED_COLUMNS=("CIP Number" "Title" "Category" "Hardfork Required" "Status" "Priority" "Rank" "Dependencies" "Impact Areas" "Added Date" "Last Reviewed" "Notes")
          
          HEADERS=$(head -n 1 shortlist/current-shortlist.md)
          
          for col in "${REQUIRED_COLUMNS[@]}"; do
            if ! echo "$HEADERS" | grep -q "$col"; then
              echo "Error: Required column '$col' not found in shortlist table"
              exit 1
            fi
          done
          
          echo "✓ All required columns present"

      - name: Validate CIP links
        run: |
          # Extract CIP links and validate format
          CIP_LINKS=$(grep -oP '\[CIP-\d+\]\(https://github.com/cardano-foundation/CIPs/blob/master/CIP-\d+\)' shortlist/current-shortlist.md || true)
          
          if [ -n "$CIP_LINKS" ]; then
            echo "Found CIP links:"
            echo "$CIP_LINKS"
            echo "✓ CIP link format appears valid"
          else
            echo "Note: No CIP links found (this is OK for an empty shortlist)"
          fi

      - name: Check date format
        run: |
          # Check that dates follow YYYY-MM-DD format if present
          DATES=$(grep -oP '\d{4}-\d{2}-\d{2}' shortlist/current-shortlist.md || true)
          
          if [ -n "$DATES" ]; then
            echo "Found dates:"
            echo "$DATES"
            # Basic validation - check format matches YYYY-MM-DD
            for date in $DATES; do
              if ! echo "$date" | grep -qE '^\d{4}-\d{2}-\d{2}$'; then
                echo "Warning: Date '$date' may not be in YYYY-MM-DD format"
              fi
            done
          fi
          
          echo "✓ Date format check complete"

      - name: Summary
        run: |
          echo "## Validation Summary"
          echo ""
          echo "✓ Markdown table format validated"
          echo "✓ Required columns checked"
          echo "✓ CIP link format validated"
          echo "✓ Date format checked"
          echo ""
          echo "Shortlist validation passed!"

